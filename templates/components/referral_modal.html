{% load i18n %}
{% load static %}
{% if user.is_authenticated and not user.referral_source %}
<!--
 This template is for new users to see when they sign up.
 Shows a fullscreen modal once per day using a cookie.
-->
    <div x-data="{
                 fullscreenModal: false,
                 showOtherInput: false,
                 customSource: '',
                 showOnce() {
                 // Check for existing cookie
                 const cookieValue = document.cookie.split('; ').find(row => row.startsWith('hasSeenModal='));
                 return !(cookieValue && cookieValue.split('=')[1] === 'true');
                 },
                 setSeenCookie() {
                 // Expire in 1 day
                 const date = new Date();
                 date.setTime(date.getTime() + 24 * 60 * 60 * 1000);
                 document.cookie = `hasSeenModal=true; expires=${date.toUTCString()}; path=/`;
                 },
                 submitReferral(source) {
                 if (source === 'Other' && !this.showOtherInput) {
                 this.showOtherInput = true;
                 return;
                 }

                 const finalSource = (source === 'Other') ? this.customSource : source;

                 if (!finalSource) return; // Don't submit empty

                 fetch('{% url 'update_referral_source' %}', {
                 method: 'POST',
                 headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': '{{ csrf_token }}'
                 },
                 body: JSON.stringify({ referral_source: finalSource })
                 })
                 .then(response => {
                 if (response.ok) {
                 this.fullscreenModal = false;
                 this.setSeenCookie();
                 window.location.reload();
                 }
                 });
                 }
                 }" x-init="(() => {
                                if (showOnce()) {
                                setTimeout(() => {
                                fullscreenModal = true;
                                $watch('fullscreenModal', function(value){
                                if(value === true){
                                document.body.classList.add('overflow-hidden');
                                } else {
                                document.body.classList.remove('overflow-hidden');
                                }
                                });
                                }, 1000);
                                }
                                })()" @keydown.escape="fullscreenModal = false; setSeenCookie();" class="relative z-[99]">
        <template x-teleport="body">
            <div x-show="fullscreenModal" x-cloak x-transition:enter="transition ease-out duration-500"
                 x-transition:enter-start="translate-y-full" x-transition:enter-end="translate-y-0"
                 x-transition:leave="transition ease-in duration-500" x-transition:leave-start="translate-y-0"
                 x-transition:leave-end="translate-y-full" class="flex fixed inset-0 z-[99] w-screen h-screen bg-white">
                <button @click="fullscreenModal = false; setSeenCookie();"
                        class="absolute top-0 right-0 z-30 flex items-center justify-center px-3 py-2 mt-3 mr-3 space-x-1 text-xs font-medium uppercase border rounded-md border-neutral-200 lg:border-white/20 lg:bg-black/10 hover:lg:bg-black/30 text-neutral-600 lg:text-white hover:bg-neutral-100">
                    {% heroicon_outline "x-mark" class="w-4 h-4" %}
                    <span>Close</span>
                </button>

                <div class="relative flex flex-wrap items-center w-full h-full px-8">
                    <div class="relative w-full max-w-sm mx-auto lg:mb-0">
                        <div class="relative text-center">
                            <div class="flex flex-col mb-6 space-y-2">
                                <h1 class="text-2xl font-semibold tracking-tight">How did you hear about us?</h1>
                                <p class="text-sm text-neutral-500"
                                   x-text="showOtherInput ? 'Please specify below.' : 'Help us improve by letting us know.'">
                                </p>
                            </div>

                            <div class="space-y-3" x-show="!showOtherInput"
                                 x-transition:enter="transition ease-out duration-300 transform"
                                 x-transition:enter-start="opacity-0 translate-y-2"
                                 x-transition:enter-end="opacity-100 translate-y-0">
                                <button @click="submitReferral('Google')"
                                        class="group relative w-full flex justify-center py-3 px-4 border border-gray-200 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all duration-300 hover:shadow-lg">
                                    Google
                                </button>
                                <button @click="submitReferral('Twitter')"
                                        class="group relative w-full flex justify-center py-3 px-4 border border-gray-200 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all duration-300 hover:shadow-lg">
                                    Twitter
                                </button>
                                <button @click="submitReferral('Friend')"
                                        class="group relative w-full flex justify-center py-3 px-4 border border-gray-200 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all duration-300 hover:shadow-lg">
                                    Friend
                                </button>
                                <button @click="submitReferral('Facebook')"
                                        class="group relative w-full flex justify-center py-3 px-4 border border-gray-200 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all duration-300 hover:shadow-lg">
                                    Facebook
                                </button>
                                <button @click="submitReferral('Other')"
                                        class="group relative w-full flex justify-center py-3 px-4 border border-gray-200 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all duration-300 hover:shadow-lg">
                                    Other
                                </button>
                            </div>

                            <div x-show="showOtherInput" x-cloak
                                 x-transition:enter="transition ease-out duration-300 transform"
                                 x-transition:enter-start="opacity-0 translate-y-2"
                                 x-transition:enter-end="opacity-100 translate-y-0" class="space-y-3">
                                <input type="text" x-model="customSource" @keydown.enter="submitReferral('Other')"
                                       placeholder="Type here..."
                                       class="w-full px-4 py-3 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                       autofocus>
                                <div class="flex space-x-2">
                                    <button @click="showOtherInput = false"
                                            class="w-1/3 py-3 px-4 border border-gray-200 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 transition-all">Back</button>
                                    <button @click="submitReferral('Other')"
                                            class="w-2/3 py-3 px-4 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 shadow-md hover:shadow-lg transition-all">Submit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative top-0 bottom-0 right-0 flex-shrink-0 hidden w-1/3 overflow-hidden bg-cover lg:block">
                    <div class="absolute inset-0 z-20 w-full h-full opacity-70 bg-gradient-to-t from-black"></div>
                    <img src="{% static 'images/logo.png' %}" class="z-10 object-cover w-full h-full"
                         onerror="this.style.display='none'" />
                <!-- Fallback gradient if image missing -->
                    <div class="absolute inset-0 z-0 bg-blue-600"></div>
                </div>
            </div>
        </template>
    </div>
{% endif %}